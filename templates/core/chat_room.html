{% extends "base.html" %}
{% load static %}


{% block title %}
Chat with {{ target_user.username }}
{% endblock %}

{% block content %}

<h1>{{ target_user.username }} さんとのチャット</h1>

<ul id="messages" data-lastid="{% firstof messages.last.id 0 %}">
  {# ② 既存履歴をサーバで描画したい場合はここを残す #}
  {% for m in messages %}
    <li><strong>{{ m.sender.username }}:</strong> {{ m.text }}</li>
  {% endfor %}
</ul>

<form id="chatForm">
  {% csrf_token %}
  <input id="msgInput" type="text" autocomplete="off" required>
  <button>送信</button>
</form>

<p><a href="{% url 'matched_list' %}">マッチ一覧へ戻る</a></p>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const list   = document.getElementById('messages');
  let lastId   = Number(list.dataset.lastid) || 0;
  const API    = "{% url 'chat_api' user_id=target_user.id %}";

  function append(m){
    const li = document.createElement('li');
    li.innerHTML = `<strong>${m.sender}:</strong> ${m.text}`;
    list.appendChild(li);
    li.scrollIntoView();
    lastId = m.id;
  }

  function poll(){
    fetch(`${API}?after=${lastId}`)
      .then(r => r.json())
      .then(({messages}) => messages.forEach(append))
      .catch(console.error);
  }
  poll();
  setInterval(poll, 5000);

  // 送信
  const form = document.getElementById('chatForm');
  const input = document.getElementById('msgInput');
  form.addEventListener('submit', e => {
    e.preventDefault();
    if(!input.value.trim()) return;
    // 通常の POST で送信 → サーバが 302 で同ページへ
    fetch(location.href, {
      method: 'POST',
      headers: {'X-CSRFToken': '{{ csrf_token }}'},
      body: new URLSearchParams({text: input.value.trim()})
    }).then(() => { input.value=''; poll(); });
  });
});
</script>

    

{% endblock %}

