{% extends "base.html" %}
{% load static %}


{% block title %}
Chat with {{ target_user.username }}
{% endblock %}

{% block content %}

<div class="chat chat-room container">

  <h1>{{ target_user.username }} さんとのチャット</h1>

  <ul id="messages" data-lastid="{% firstof messages.last.id 0 %}">
      {% for m in messages %}
      <li class="{% if m.sender == request.user %}me{% else %}you{% endif %}">
        {% if m.sender != request.user %}
          <img class="avatar"
              src="{% if m.sender.userprofile.profile_image %}
                      {{ m.sender.userprofile.profile_image.url }}
                    {% else %}
                      {% static 'img/user-unset.webp' %}
                    {% endif %}"
              alt="">
        {% endif %}
        <div class="bubble">{{ m.text }}</div>
      </li>
      {% endfor %}
  </ul>

  <form id="chatForm" class="send-form">
    {% csrf_token %}
  <textarea id="msgInput" rows="2" placeholder="メッセージを入力…" required></textarea>
    <button>送信</button>
  </form>

  <p class="back-index"><a href="{% url 'chat_index' %}">マッチ一覧へ戻る</a></p>
  
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const list   = document.getElementById('messages');
  let lastId   = Number(list.dataset.lastid) || 0;
  const API    = "{% url 'chat_api' user_id=target_user.id %}";
  const CURRENT = "{{ request.user.username|escapejs }}";   // ← 自分の名前をJSへ
const MY_AVATAR = "{% if request.user.userprofile.profile_image %}
                     {{ request.user.userprofile.profile_image.url }}
                   {% else %}
                     {% static 'img/user-unset.webp' %}
                   {% endif %}";

function append(m){
  const isMe = (m.sender === CURRENT);
  const li   = document.createElement('li');
  li.className = isMe ? 'me' : 'you';

  const avatar = isMe ? MY_AVATAR : m.avatar;
  li.innerHTML =
    (isMe ? '' : `<img class="avatar" src="${avatar}" alt="">`) +
    `<div class="bubble">${m.text}</div>`;

  list.appendChild(li);
  li.scrollIntoView();
  lastId = m.id;
}

  function poll(){
    fetch(`${API}?after=${lastId}`)
      .then(r => r.json())
      .then(({messages}) => messages.forEach(append))
      .catch(console.error);
  }
  poll();
  setInterval(poll, 5000);

  // 送信
  const form = document.getElementById('chatForm');
  const input = document.getElementById('msgInput');
  form.addEventListener('submit', e => {
    e.preventDefault();
    if(!input.value.trim()) return;
    // 通常の POST で送信 → サーバが 302 で同ページへ
    fetch(location.href, {
      method: 'POST',
      headers: {'X-CSRFToken': '{{ csrf_token }}'},
      body: new URLSearchParams({text: input.value.trim()})
    }).then(() => { input.value=''; poll(); });
  });
});
</script>

    

{% endblock %}

